version: '3.8'

# Cortex Suite Docker Compose (single-container architecture)
#
# STORAGE MODES:
#   Portable (default):  docker compose --profile cpu up -d
#   External storage:    docker compose --profile cpu -f docker-compose.yml -f docker-compose.external.yml up -d
#
# GPU mode:
#   docker compose --profile gpu up -d

services:
  cortex-suite-cpu:
    profiles: ["cpu"]
    build:
      context: .
      dockerfile: Dockerfile
    container_name: cortex-suite
    restart: unless-stopped
    ports:
      - "${CORTEX_UI_PORT:-8501}:8501"
      - "${CORTEX_API_PORT:-8000}:8000"
      - "${CORTEX_OLLAMA_PORT:-11434}:11434"
    volumes:
      - cortex_data:/data/ai_databases
      - knowledge_base:/data/knowledge_base
      - ollama_data:/home/cortex/.ollama
      - cortex_logs:/home/cortex/app/logs
    environment:
      - AI_DATABASE_PATH=/data/ai_databases
      - KNOWLEDGE_SOURCE_PATH=/data/knowledge_base
      - OLLAMA_HOST=0.0.0.0:11434
      - OLLAMA_ORIGINS=*
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    env_file:
      - .env
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8501/_stcore/health && curl -fsS http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  cortex-suite-gpu:
    profiles: ["gpu"]
    build:
      context: .
      dockerfile: Dockerfile.gpu
    container_name: cortex-suite-gpu
    restart: unless-stopped
    ports:
      - "${CORTEX_UI_PORT:-8501}:8501"
      - "${CORTEX_API_PORT:-8000}:8000"
      - "${CORTEX_OLLAMA_PORT:-11434}:11434"
    volumes:
      - cortex_data:/data/ai_databases
      - knowledge_base:/data/knowledge_base
      - ollama_data:/home/cortex/.ollama
      - cortex_logs:/home/cortex/app/logs
    environment:
      - AI_DATABASE_PATH=/data/ai_databases
      - KNOWLEDGE_SOURCE_PATH=/data/knowledge_base
      - OLLAMA_HOST=0.0.0.0:11434
      - OLLAMA_ORIGINS=*
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
    env_file:
      - .env
    gpus: all
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8501/_stcore/health && curl -fsS http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

volumes:
  ollama_data:
    driver: local
  cortex_data:
    driver: local
    name: cortex_ai_databases
  knowledge_base:
    driver: local
    name: cortex_knowledge_base
  cortex_logs:
    driver: local

networks:
  default:
    name: cortex-network
